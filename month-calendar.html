<!DOCTYPE html>
<html>

<head>
    <title>Glance</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<style>
    .custom-menu {
        display: none;
        z-index: 1000;
        position: absolute;
        overflow: hidden;
        border: 1px solid #CCC;
        white-space: nowrap;
        font-family: sans-serif;
        background: #FFF;
        color: #333;
        border-radius: 5px;
        padding: 0;
    }

    /* Each of the items in the list */

    .custom-menu li {
        padding: 8px 12px;
        cursor: pointer;
        list-style-type: none;
        transition: all .3s ease;
        user-select: none;
    }

    .custom-menu li:hover {
        background-color: #DEF;
    }
</style>
<script>
    $(document).ready(function () {
		setUpMonthCalendar();

		
		function setUpMonthCalendar()
		{
			$('#monthtablebody').empty();
			$('#clienttablebody').empty();
			$('.custom-menu').empty();
			$.get("backend/getConsultantsAndClients_month.php", function (data) {

            var databaseResults = [],
                clients = [],
                consultants = [];

            databaseResults = JSON.parse(data); //Store consultant and client arrays recieved from server

            consultants = databaseResults[0]; //Store array of consultants

            clients = databaseResults[1]; //Store array of clients

            for (x in consultants) {
                addConsultantToMonthlyBoard(consultants[x]) //update consultant table by each row
            }

            addClientToMonthlyBoard(clients); //update client table
			});
		}
		//update consultant table by each row
        function addConsultantToMonthlyBoard(consultant) {
            var consultantHTML = "";

            consultantHTML = "<tr data-id='"+consultant['id']+"'>";
            consultantHTML += "<td>" + consultant['name'] + "</td>";
			for(var i=1;i<=4;i++) //Four weeks
			{
				var clientName="";
				var allocation = getAllocation(consultant['allocations'],i); //get allocation for the column if any
				if(allocation)
				{
					clientName= allocation["full_name"];
				}
				consultantHTML += "<td class='allocation'>"+clientName+"</td>";
			}
            consultantHTML += "</tr>";

            $("#monthtablebody").append(consultantHTML);
        }
		
		function getAllocation(allocations,col)
		{
			var allocation = {};

			for (y in allocations) 
			{
				allocation = allocations[y];
				if(allocation["allocation_slot"]==col) //if column is matching
				{
					return allocation;
				}
			}
			return null;
		}
        function addClientToMonthlyBoard(clients) {
            var clientHTML = "",
                listHtml = "";

            clientHTML = "<tr><td>";
            for (x in clients) {

                clientHTML += clients[x]['name'] + "<br>";
                listHtml += "<li data-action='" + clients[x]['id'] + "'>" + clients[x]['name'] + "</li>";

            }
            clientHTML += "</td></tr>";
			 listHtml += "<li data-action='0' data-flag='1'>Delete</li>"; //delete option
            $("#clienttablebody").append(clientHTML);
            $(".custom-menu").append(listHtml);
        }

        // JAVASCRIPT (jQuery)

        // Trigger action when the contexmenu is about to be shown

        $("#monthtable").on("contextmenu", ".allocation", function (event) {
			$("#clicked").removeAttr('id'); 
			$(this).attr("id","clicked"); //targets this element for context action
            // Avoid the real one
            event.preventDefault();

            // Show contextmenu
            $(".custom-menu").finish().toggle(100).

                // In the right position (the mouse)
                css({
                    top: event.pageY + "px",
                    left: event.pageX + "px"
                });
        });


        // If the document is clicked somewhere
        $(document).bind("mousedown", function (e) {

            // If the clicked element is not the menu
            if (!$(e.target).parents(".custom-menu").length > 0) {
				$("#clicked").removeAttr('id');
                // Hide it
                $(".custom-menu").hide(100);
            }
        });
		
		$(".custom-menu").on("click","li", function() {
			var col = $('#clicked').index(); //column of the table
			var $tr = $('#clicked').closest('tr'); //consultant row
			var consultantId = $tr.data('id'); //consultant Id
			var clientId = $(this).data('action'); //client Id
			var isAdding = 1;
			if($(this).data('flag')==1) //if it is deleting
			{
				isAdding = 0;
			}
			//console.log("col "+col+" consultantId "+$tr.data('id')+" client "+clientId);
			
			$.post(
                'backend/updateAllocation_month.php',
                {
                    col: col,
                    clientId: clientId,
					consultantId: consultantId,
					isAdding : isAdding
                }, function (data) {
                    if (data == 'success') {
						setUpMonthCalendar(); //update the table
						console.log('success');
					}
					else
					{
						console.log(data);
					} 
				}
            )
			//clear up
			$("#clicked").removeAttr('id');
			// Hide it
			$(".custom-menu").hide(100);
		});



    });
</script>

<body>
    <ul class='custom-menu'>
    </ul>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <!-- Links -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="week-calendar.html">Week Calendar</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="month-calendar.html">Month Calendar</a>
                </li>
            </ul>
    
        </nav>
    <table id="monthtable" class="table table-bordered">
        <thead id="monthtablehead">
            <tr id="monthtableheadrow">
                <th>Consultants</th>
                <th>This Week </th>
                <th>Week 2 </th>
                <th>Week 3 </th>
                <th>Week 4 </th>
            </tr>
        </thead>
        <tbody id="monthtablebody">
        </tbody>
    </table>
    <table id="clienttable" class="table table-bordered">
        <thead id="clienttablehead">
            <tr id="clienttableheadrow">
                <th>Client</th>
            </tr>
        </thead>
        <tbody id="clienttablebody">
        </tbody>
    </table>
</body>

</html>