<!DOCTYPE html>
<html>

<head>
    <title>Glance</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
</head>

<style type="text/css">
</style>

<script>
    $(document).ready(function () { //Load the javascript when the page is loaded

        //Retrieve client and consultant information from the database and render to page

        function initialiseTables() {
            //Retrieve the initial client and consultants and renders them in their tables
            $.get("getConsultantsAndClients.php", function (data) {
                var databaseResults = [],
                    clients = [],
                    consultants = [];

                databaseResults = JSON.parse(data); //Decode json to array of clients

                consultants = databaseResults[0]; //Decode json to array of clients

                clients = databaseResults[1]; //Decode json to array of clients

                for (x in clients) {
                    addClientToTable(clients[x], consultants);
                }

                for (x in consultants) {
                    addConsultantToTable(consultants[x], clients);
                }
            })
        }

        //Appends a client to the cliet table 
        function addClientToTable(client, consultants) {
            var clientRow = "",
                consultant = {};


            clientRow = "<tr id='" + client['id'] + "' data-abbrevation='" + client['abbrevation'] + "'>";
            clientRow += "<td>" + client['name'] + "</td>";
            clientRow += "<td>" + client['abbrevation'] + "</td>";
            clientRow += "<td class='who-column'>";
            for (x in consultants) {
                consultant = consultants[x];
                var clientAllocations = "";
                for (k in consultant) {
                    if (consultant[k] == client["abbrevation"]) { //Check that property of the consultant is the same as the the current client abbrevation
                        if (!(clientAllocations.includes(consultant["name"]))) { //Check that clientAllocations DOES NOT include the name of the selected consultant
                            clientAllocations += consultant["name"] + " ";
                        }
                    }
                }
                clientRow += clientAllocations;
            }
            clientRow += "</td>";
            clientRow += "<td><input type='button' class='remove-client-btn btn' value='REMOVE'/></td>";
            clientRow += "</tr>";
            $("#clienttablebody").append(clientRow);
        }

        //Appends a consultants to the consultant table
        function addConsultantToTable(consultant, clients) {
            var consultantRow = "", //Stores html representaion of consultant
                client = {}; //Store

            consultantRow = "<tr id='" + consultant['id'] + "' data-name='" + consultant['name'] + "'>";
            consultantRow += "<td>" + consultant['name'] + "</td>"
            for (i = 0; i < 10; i++) {
                consultantRow += "<td><select class='form-control clientdropdown' id='allocation" + i + "'>";
                consultantRow += "<option value='null'></option>"
                for (z in clients) {
                    client = clients[z];
                    consultantRow += "<option value='" + client['abbrevation'] + "'";
                    if (consultant["allocation" + i] == client["abbrevation"]) {

                        consultantRow += " selected='selected'"
                    }
                    consultantRow += ">" + client['abbrevation'] + "</option>"
                }
                consultantRow += "</select></td>";
            }
            consultantRow += "<td><input type='button' class='remove-consultant-btn btn' value='REMOVE'/></td>";
            consultantRow += "</tr>";
            $("#consultantstablebody").append(consultantRow);
        }

        //Add a click event to the "Add Client" button
        $("#addclientbutton").click(function () { //Add a click event to the addclientbutton
            var newClientName = "",
                newClientAbbrevation = "",
                nameUnique = true,
                abbrevationUnique = true,
                clients = [],
                consultants = [];

            newClientName = $("#clientnameinput").val(); //Store name of client to be added
            newClientAbbrevation = $("#clientabrevationinput").val(); //Store abbrevation of client to be added
            newClientAbbrevation = newClientAbbrevation.toUpperCase();

            $.get("getClients.php", function (data, status) {
                clients = JSON.parse(data);

                for (x in clients) {
                    if (clients[x]['name'] == newClientName) {
                        nameUnique = false;
                    }
                    if (clients[x]['abbrevation'] == newClientAbbrevation) {
                        abbrevationUnique = false;
                    }
                }

                if (nameUnique) {
                    if (abbrevationUnique) {
                        $.get("getConsultants.php", function (data, status) {
                            consultants = JSON.parse(data);

                            $.post("addNewClient.php", //Request data from server using POST, url is addClient.php
                                {
                                    clientName: newClientName, //Pass the value of client name input to server
                                    clientAbbrev: newClientAbbrevation  //Pass the value of client abbrevation input to server
                                },
                                function (data) { //After response is recieved from server
                                    var clientDropdownOption = "",
                                        addedClient = {};

                                    clientDropdownOption += "<option value='" + newClientAbbrevation + "'>";
                                    clientDropdownOption += newClientAbbrevation + "</option>"
                                    $(".clientdropdown").append(clientDropdownOption) //Add the abbreavtion of the added client to the consultant's dropdown

                                    addedClient = JSON.parse(data);
                                    addClientToTable(addedClient, consultants); //Append the data recieved from the server to the client table
                                });
                        })
                    }
                    else {
                        alert("Abbrevation is not unquie");
                    }
                }
                else {
                    alert("Name is not unquie");
                }
            })
        })

        //Add a click event to all "Remove" buttons on client rows
        $("#clientstable").on("click", ".remove-client-btn", function () {
            var thisClientRow = {},
                thisClientID = 0,
                clientAbbrevation = "";

            thisClientRow = $(this).closest("tr"); //Store the client table row
            thisClientID = thisClientRow.prop('id'); //Store client id
            clientAbbrevation = thisClientRow.data('abbrevation');

            $.post("removeClient.php", //Request data from server using POST, url is removeClient.php
                {
                    clientID: thisClientID //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                }, function () {
                    $("option[value='" + clientAbbrevation + "']").remove(); //Remove the abbrevation from the consultant dropdown
                    thisClientRow.remove(); //Remove the closest table row to the button
                });

        });

        // Add a click event to the "Add Consultant" button
        $("#addconsultantbutton").click(function () { //Add a click event to the add consultant button
            var newConsultantName = "",
                newConsultantRole = "",
                nameUnique = true,
                consultants = {},
                addedConsultant = {},
                clients = [];


            newConsultantName = $("#consultantnameinput").val();
            newConsultantRole = $("#consultantroleinput").val();
            $.get("getConsultants.php", function (data) {
                consultants = JSON.parse(data);

                for (x in consultants) {
                    if (consultants[x]['name'] == newConsultantName) {
                        nameUnique = false;
                    }
                }

                if (nameUnique) {
                    $.get("getClients.php", function (data) {
                        clients = JSON.parse(data);

                        $.post("addNewConsultant.php", //Request data from server using POST, url is addClient.php
                            {
                                consultantName: newConsultantName, //Pass the value of client name input to server
                                consultantJob: newConsultantRole  //Pass the value of client abbrevation input to server
                            },
                            function (data) { //Call back function to excute after the request to the server is processed
                                addedConsultant = JSON.parse(data);
                                addConsultantToTable(addedConsultant, clients);
                            });
                    })
                }
                else {
                    alert("Name is not unique");
                }
            })
        })

        //Add a click event to all remove remove consultant button on the client table
        $("#consultantstable").on("click", ".remove-consultant-btn", function () {
            var thisConsultantRow = {},
                consultantID = "";

            thisConsultantRow = $(this).closest("tr");
            consultantID = thisConsultantRow.prop("id");

            $.post("removeConsultant.php", //Request data from server using POST, url is removeClient.php
                {
                    consultantID: consultantID //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                }, function (data) {
                    thisConsultantRow.remove(); //Remove the closest table row to the button
                });

        });

        //WHen the dropdown for a consultant is chnaged send this update to the database
        $("#consultantstable").on("change", ".clientdropdown", function () {
            var selectedClientAbbrevation = "",
                allocationNo = "",
                consultantRow = {},
                consultantID = 0;

            selectedClientAbbrevation = $(this).find(":selected").val();
            allocationNo = $(this).prop("id");
            consultantRow = $(this).closest("tr");
            consultantID = consultantRow.prop("id")

            $.post("updateAllocation.php",
                {
                    consultantID: consultantID,
                    clientAbbrevation: selectedClientAbbrevation,
                    allocationNo: allocationNo
                }, function (data) {
                    checkIfConsultantIsAllocatedToClients(consultantID);
                });
        });


        /*
        function checkIfConsultantIsAllocatedToClients
        
        Takes a consultant ID name as a parameter. Checks all of the consultant's allocations, and 
        makes any necessary adjustments to client's WHO colunm.
        
        */
        function checkIfConsultantIsAllocatedToClients(consultantID) {
            $('#clienttablebody > tr').each(function () {
                var clientRow = $(this);
                var i = 0;
                var consultantRow = $("#consultantstablebody").find("#" + consultantID);
                var consultantName = consultantRow.data('name');

                allocatedClients = clientRow.find(".who-column").html();


                for (i; i < 10; i++) {
                    allocation = consultantRow.find("#allocation" + i);
                    if (allocation.val() == clientRow.data('abbrevation')) {

                        if (!(allocatedClients.includes(consultantName))) {
                            updatedAllocatedClients = allocatedClients + " " + consultantName;
                            clientRow.find(".who-column").html(updatedAllocatedClients);
                        }

                        return;
                    }
                }

                updatedAllocatedClients = allocatedClients.replace(consultantName, "");
                clientRow.find(".who-column").html(updatedAllocatedClients);

            })
        }

        //Populate page
        initialiseTables();

        $("#testbutton").click(function () {
            checkIfConsultantsIsStillAllocatedToClient("WOR");
        })
    })
</script>

<body>
    <div id="maindiv">
        <div id="consultantsdiv">
            <table id="consultantstable" class="table">
                <thead id="consultantstablehead">
                    <tr>
                        <th>Consultant</th>
                        <th colspan="2">Monday </th>
                        <th colspan="2">Tue</th>
                        <th colspan="2">Wed</th>
                        <th colspan="2">Thu</th>
                        <th colspan="2">Fri</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                    </tr>
                </thead>
                <tbody id="consultantstablebody">

                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Consultant Name" value="Test" id="consultantnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Consultant Role" value="Test" id="consultantroleinput" />
                </td>
                <td>
                    <input type="button" class="btn" value="Add Consultant" id="addconsultantbutton" />
                </td>
            </tr>
        </div>
        <div id="clientsdiv">
            <table id="clientstable" class="table">
                <thead id="clienttablehead">
                    <th>Client</th>
                    <th>Abbrevation</th>
                    <th>Who</th>
                </thead>
                <tbody id="clienttablebody">
                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Client Name" value="Test" id="clientnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Client Abbrevation" value="Tes" id="clientabrevationinput" maxlength="3" />
                </td>
                <td>
                    <input type="button" class="btn" value="Add Client" id="addclientbutton" />
                </td>
            </tr>
        </div>
        <input type="button" id="testbutton" value="Test">
        </input>
    </div>
</body>

</html>