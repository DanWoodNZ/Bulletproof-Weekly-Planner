<!DOCTYPE html>
<html>

<head>
    <title>Glance</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
</head>

<style type="text/css">
    /* Inputs with the class .names now as appear as normal text  */

    .names {
        background: rgba(0, 0, 0, 0);
        border: none;
        width: fit-content;
    }

    /* Increase the default width of txt input elements */

    input[type=text] {
        width: 300px;
    }
</style>

<script>
    $(document).ready(function () { //Load the javascript when the page is loaded

        //Intialise arrays for clients and consultants
        var clients = [],
            consultants = [];

        //Retrieve the JSON representation of clients from the server 
        $.get("getClients.php", function (data, status) {

            clients = JSON.parse(data); //Decode json to array of clients

            //Retrieve the JSON representation of clients from the server
            $.get("getConsultants.php", function (data, status) {
                alert(data);
                consultants = JSON.parse(data); //Decode json to array of consultants
                //Populate the client table with information from the database
                for (x in clients) {
                    addClientRow(clients[x]);
                }
                //Populate the consultant table with information from the database
                for (x in consultants) {
                    addConsultantRow(consultants[x]);
                }
            })
        })

        // Add a click event to the add client button
        $("#addclientbutton").click(function () { //Add a click event to the addclientbutton
            var newClientName, newClientAbbrevation;
            newClientName = $("#clientnameinput").val(); //Store name of client to be added
            newClientAbbrevation = $("#clientabrevationinput").val(); //Store abbrevation of client to be added

            $.post("addNewClient.php", //Request data from server using POST, url is addClient.php
                {
                    clientName: newClientName, //Pass the value of client name input to server
                    clientAbbrev: newClientAbbrevation  //Pass the value of client abbrevation input to server
                },
                function (data) { //After response is recieved from server
                    var clientDropdownOption = "",
                        addedClient = {};

                    clientDropdownOption += "<option value='" + newClientAbbrevation + "'>";
                    clientDropdownOption += newClientAbbrevation + "</option>"
                    $(".clientdropdown").append(clientDropdownOption) //Add the abbreavtion of the added client to the consultant's dropdown

                    addedClient = JSON.parse(data);
                    addClientRow(addedClient); //Append the data recieved from the server to the client table
                    clients.push(addedClient);
                });
        });

        // Add a click event to the add consultant button
        $("#addconsultantbutton").click(function () { //Add a click event to the addclientbutton
            $.post("addNewConsultant.php", //Request data from server using POST, url is addClient.php
                {
                    consultantName: $("#consultantnameinput").val(), //Pass the value of client name input to server
                    consultantJob: $("#consultantroleinput").val()  //Pass the value of client abbrevation input to server
                },
                function (data) { //Call back function to excute after the request to the server is processed
                    addConsultantRow(JSON.parse(data));
                });
        });

        //Takes a single client and appends it to the client table
        function addClientRow(client) {
            var clientRow = "";
            clientRow += "<tr id='" + client['id'] + "'>";
            clientRow += "<td><input type='text' id='clientName' class='names' value='" + client['name'] + "'></input></td>";
            clientRow += "<td id='clientAbbrevation'>" + client['abbrevation'] + "</td>";
            clientRow += "<td id='allocatedclients'>";
            for (z in consultants) { //Loop through number of consultants
                consultant = consultants[z]; //Store a consultant
                var clientAllocations = "";
                for (const k in consultant) { //Loop through all the propoerties of the consultant
                    //Start new string for client 
                    if (consultant[k] == client["abbrevation"]) { //Check that property of the consultant is the same as the the current client abbrevation
                        if (!(clientAllocations.includes(consultant["name"]))) { //Check that clientAllocations DOES NOT include the name of the selected consultant
                            clientAllocations += consultant["name"] + " ";
                        }
                    }
                }
                clientRow += clientAllocations;
            }
            clientRow += "</td>";
            clientRow += "<td><input type='button' id='removeClient' value='REMOVE'/></td>";
            clientRow += "</tr>";
            $("#clienttablebody").append(clientRow);
        }

        //Takes a single consulant and appends it to the consultant table
        function addConsultantRow(consultant) {
            var consultantRow = ""; //Begin new consultant row
            consultantRow += "<tr id='" + consultant['id'] + "'>";
            consultantRow += "<td><input type='text' id='consultantName' class='names' value='" + consultant['name'] + "'></input><br>" + consultant['role'] + "</td>"
            for (i = 0; i < 10; i++) {
                consultantRow += "<td><select class='form-control clientdropdown' id='allocation" + i + "'>";
                consultantRow += "<option value='null'></option>"
                for (z in clients) {
                    var client = clients[z];
                    consultantRow += "<option value='" + client['abbrevation'] + "'";
                    if (consultant["allocation" + i] == client["abbrevation"]) {

                        consultantRow += " selected='selected'"
                    }
                    consultantRow += ">" + client['abbrevation'] + "</option>"
                }
                consultantRow += "</select></td>";
            }
            consultantRow += "<td><input type='button' id='removeConsultant' value='REMOVE'/></td>";
            consultantRow += "</tr>";
            $("#consultantstablebody").append(consultantRow);
        }

        //WHen the dropdown for a consultant is chnaged send this update to the database
        $("#consultantstable").on("change", ".clientdropdown", function () {

            var selectedClient = $(this).find(":selected").val();
            var allocationNo = $(this).prop("id");
            var consultantRow = $(this).closest("tr");
            var consultantName = consultantRow.find("#consultantName").prop("value");
            var consultantID = consultantRow.prop("id")
            checkConsultantsAllocations(consultantID);

            $.post("updateAllocation.php",
                {
                    consultantName: consultantName,
                    clientAbbrevation: selectedClient,
                    allocationNo: allocationNo
                }, function (data) {
                });
        });

        //Add a click event to all remove client button on the client table
        $("#clientstable").on("click", "#removeClient", function () {

            var thisClientRow = $(this).closest("tr"); //Store the client table row
            var thisClientAbbrevation = thisClientRow.find("#clientAbbrevation").html(); //Store client abbrevation
            var thisClientName = thisClientRow.find("#clientName").val(); //Store client name


            $.post("removeClient.php", //Request data from server using POST, url is removeClient.php
                {
                    clientName: thisClientName //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                }, function () {
                    $("option[value='" + thisClientAbbrevation + "']").remove(); //Remove the abbrevation from the consultant dropdown
                });
            $(this).closest("tr").remove(); //Remove the closest table row to the button
        });

        //Add a click event to all remove client button on the client table
        $("#consultantstable").on("click", "#removeConsultant", function () {

            alert($(this).closest("tr").find("#consultantName").html());

            $.post("removeConsultant.php", //Request data from server using POST, url is removeClient.php
                {
                    consultantName: $(this).closest("tr").find("#consultantName").html() //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                });
            $(this).closest("tr").remove(); //Remove the closest table row to the button
        });

        //Funcation takes a consultant ID and a Clientname and returns true if that consultatnt has any allocation to the client
        function checkIfConsultantIsAllocatedToClient(consultantID, clientAbbrevation) {
            var clientCheck = false;
            var consultantRow = $("#" + consultantID);
            var i = 0;

            for (i; i < 10; i++) {
                clientForDay = consultantRow.find("#allocation" + i).val();
                if (clientForDay === clientAbbrevation) {
                    clientCheck = true;
                }
            }
            if (clientCheck == true) {
                return true;
            }

            else {
                return false;
            }
        }

        //Takes a Consultant ID, and checks if that consultant is allocated to any of the current clients
        function checkConsultantsAllocations(consultantID) {
            for (x in clients) {
                var clientAbbrevation = clients[x]['abbrevation'];
                if (checkIfConsultantIsAllocatedToClient(consultantID, clientAbbrevation)) {
                    alert("Client is allocated to " + clientAbbrevation);
                }
                else {
                    alert("Client is not allocated to " + clientAbbrevation);
                    removeConsultantFromClientWho(consultantID, clients[x]['id']);
                }
            }
        }
        /*
        *   @function removeConsultantFromClientWho
        *
        *   Removes a consultants name from a client's WHO collumn, representing the condition where the consultant
        *   is no longer working on a project for the client.
        *
        *   @param {int} consultantID -ID NO of a consultant 
        *   @param {int} clientId - ID NO of client
        *
        */
        function removeConsultantFromClientWho(consultantID, clientId) {
            var consultant = consultants.find(x => x['id'] == consultantID);
            var consultantName = consultant['name'];

            var clientRow = $("#clienttablebody").find("#" + clientId + "");
            var allocatedClients = clientRow.find("#allocatedclients").text();
            var newClients = allocatedClients.replace(consultantName, "");
            clientRow.find("#allocatedclients").text(newClients);
        }

        $("#testbutton").click(function () {
            removeConsultantFromClientWho("1", "1");
        })

    });
</script>

<body>
    <div id="maindiv">
        <div id="consultantsdiv">
            <table id="consultantstable" class="table">
                <thead id="consultantstablehead">
                    <tr>
                        <th>Client</th>
                        <th colspan="2">Monday </th>
                        <th colspan="2">Tue</th>
                        <th colspan="2">Wed</th>
                        <th colspan="2">Thu</th>
                        <th colspan="2">Fri</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                    </tr>
                </thead>
                <tbody id="consultantstablebody">

                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Consultant Name" value="Test" id="consultantnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Consultant Role" value="Test" id="consultantroleinput" />
                </td>
                <td>
                    <input type="button" value="Add Consultant" id="addconsultantbutton" />
                </td>
            </tr>
        </div>
        <div id="clientsdiv">
            <table id="clientstable" class="table">
                <thead id="clienttablehead">
                    <th>Client</th>
                    <th>Abbrevation</th>
                    <th>Who</th>
                </thead>
                <tbody id="clienttablebody">
                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Client Name" value="Test" id="clientnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Client Abbrevation" value="Test" id="clientabrevationinput" />
                </td>
                <td>
                    <input type="button" value="Add Client" id="addclientbutton" />
                </td>
            </tr>
        </div>
        <input type="button" id="testbutton" value="Test">
        </input>
    </div>
</body>

</html>