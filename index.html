<!DOCTYPE html>
<html>

<head>
    <title>Glance</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>

<style type="text/css">
    /* Inputs with the class .names now as appear as normal text  */

    .client-name-input {
        background: rgba(0, 0, 0, 0);
        border: none;
    }

    .consultant-name-input {
        background: rgba(0, 0, 0, 0);
        border: none;
    }
</style>

<script>
    //Load the javascript when the page is loaded
    $(document).ready(function () {

        /*  @function initialiseTables

            Fill the client and consulsant table bodies with information from the mySQL database. 
        */

        function initialiseTables() {
            $.get("getConsultantsAndClients.php", function (data) {
                var databaseResults = [],
                    clients = [],
                    consultants = [];

                databaseResults = JSON.parse(data); //Store consultant and client arrays recieved from server

                consultants = databaseResults[0]; //Store array of consultants

                clients = databaseResults[1]; //Store array of clients

                /*
                Iterate through the arrays of clients and consultants and ouput the information stored in these arrays
                to the page tables
                */
                for (x in clients) {
                    addClientToTable(clients[x], consultants);
                }

                for (x in consultants) {
                    addConsultantToTable(consultants[x], clients);
                }

                $("tbody").sortable(); //Using the jquery UI library, makes items within tbody elements sortable
            })
        }

        /*  @function addClientToTable

            Takes a client object and array of consultants objects as parameters. 
            Appends a row to the client table using the passed paremeters.
        */

        function addClientToTable(client, consultants) {
            var clientRow = "",
                consultant = {},
                clientAllocations = "";
        
            //Begin a new html table row containing the clients information
            clientRow = "<tr " +
                "id='" + client['id'] +
                "' data-abbrevation='" + client['abbrevation'] + "'>";
            clientRow += "<td>" +
                "<input class='client-name-input' value='" + client['name'] + "'>" +
                "</input></td>";
            clientRow += "<td>" + client['abbrevation'] + "</td>";
            clientRow += "<td class='who-column'>";

            //Checks if consultants are allocated to a client and create the appropirate innerHTML for the WHO column.
            for (x in consultants) {
                consultant = consultants[x];
                clientAllocations = "";
                for (k in consultant) { //Loop though consultant properties
                    if (consultant[k] == client["abbrevation"]) {
                        if (!(clientAllocations.includes(consultant["name"]))) { //Check name is not added twice. 
                            clientAllocations += consultant["name"] + " ";
                        }
                    }
                }
                clientRow += clientAllocations;
            }
            clientRow += "</td>";
            clientRow += "<td><input type='button' " +
                "class='remove-client-btn btn'" +
                " value='REMOVE'/></td>";
            clientRow += "</tr>";
            $("#clienttablebody").append(clientRow); //Append html table row to client table body
        }

        /*  @function addConsultantToTable

            Takes a consultant object and array of client objects as parameters. 
            Appends a row to the consultant table using the passed paremeters.
        */

        function addConsultantToTable(consultant, clients) {
            var consultantRow = "",
                client = {},
                abbrevation;

            consultantRow = "<tr id='" + consultant['id'] +
                "' data-name='" + consultant['name'] + "'>";
            consultantRow += "<td><input class='consultant-name-input' value='" + consultant['name'] + "'></input></td>"
            for (i = 0; i < 10; i++) {
                consultantRow += "<td><select" +
                    " class='form-control clientdropdown'" +
                    " id='allocation" + i + "'>";
                consultantRow += "<option value='null'></option>"
                for (z in clients) {
                    client = clients[z];
                    abbrevation = client['abbrevation'];
                    consultantRow += "<option value='" + abbrevation + "'";
                    if (consultant["allocation" + i] == abbrevation) {

                        consultantRow += " selected='selected'"
                    }
                    consultantRow += ">" + client['abbrevation'] + "</option>"
                }
                consultantRow += "</select></td>";
            }
            consultantRow += "<td><input type='button'" +
                " class='remove-consultant-btn btn'" +
                " value='REMOVE'/></td>";
            consultantRow += "</tr>";
            $("#consultantstablebody").append(consultantRow);
        }

        //Add a click event to the "Add Client" button
        $("#addclientbutton").click(function () { //Add a click event to the addclientbutton
            var newClientName = "",
                clientAbbrevation = "",
                nameUnique = true,
                abbrevationUnique = true,
                clients = [],
                consultants = [];

            newClientName = $("#clientnameinput").val(); //Store name of client to be added
            clientAbbrevation = $("#clientabrevationinput").val(); //Store abbrevation of client to be added
            clientAbbrevation = clientAbbrevation.toUpperCase();

            $.get("getClients.php", function (data, status) {
                clients = JSON.parse(data);

                for (x in clients) {
                    if (clients[x]['name'] == newClientName) {
                        nameUnique = false;
                    }
                    if (clients[x]['abbrevation'] == clientAbbrevation) {
                        abbrevationUnique = false;
                    }
                }

                if (nameUnique) {
                    if (abbrevationUnique) {
                        $.get("getConsultants.php", function (data, status) {
                            consultants = JSON.parse(data);

                            $.post("addNewClient.php", //Request data from server using POST, url is addClient.php
                                {
                                    clientName: newClientName, //Pass the value of client name input to server
                                    clientAbbrev: clientAbbrevation  //Pass the value of client abbrevation input to server
                                },
                                function (data) { //After response is recieved from server
                                    var optionHTML = "",
                                        addedClient = {};

                                    optionHTML += "<option" +
                                        " value='" + clientAbbrevation + "'>" +
                                        clientAbbrevation + "</option>";

                                    //Add the client to the list of options in allocation's dropdown
                                    $(".clientdropdown").append(optionHTML)

                                    addedClient = JSON.parse(data);
                                    addClientToTable(addedClient, consultants); //Append the data recieved from the server to the client table
                                });
                        })
                    }
                    else {
                        alert("Abbrevation is not unquie");
                    }
                }
                else {
                    alert("Name is not unquie");
                }
            })
        })

        //Add a click event to all "Remove" buttons on client rows
        $("#clientstable").on("click", ".remove-client-btn", function () {
            var thisClientRow = {},
                thisClientID = 0,
                clientAbbrevation = "";

            thisClientRow = $(this).closest("tr"); //Store the client table row
            thisClientID = thisClientRow.prop('id'); //Store client id
            clientAbbrevation = thisClientRow.data('abbrevation');

            $.post("removeClient.php", //Request data from server using POST, url is removeClient.php
                {
                    clientID: thisClientID //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                }, function () {
                    $("option[value='" + clientAbbrevation + "']").remove(); //Remove the abbrevation from the consultant dropdown
                    thisClientRow.remove(); //Remove the closest table row to the button
                });

        });

        // Add a click event to the "Add Consultant" button
        $("#addconsultantbutton").click(function () { //Add a click event to the add consultant button
            var newConsultantName = "",
                newConsultantRole = "",
                newConsultantPosition = 0,
                nameUnique = true,
                consultants = {},
                addedConsultant = {},
                clients = [];


            newConsultantName = $("#consultantnameinput").val();
            newConsultantRole = $("#consultantroleinput").val();
            $.get("getConsultants.php", function (data) {
                consultants = JSON.parse(data);

                for (x in consultants) {
                    if (consultants[x]['name'] == newConsultantName) {
                        nameUnique = false;
                    }
                }

                if (nameUnique) {
                    $.get("getClients.php", function (data) {
                        clients = JSON.parse(data);
                        newConsultantPosition = consultants.length + 1;

                        $.post("addNewConsultant.php", //Request data from server using POST, url is addClient.php
                            {
                                consultantName: newConsultantName, //Pass the value of consultant name input to server
                                consultantJob: newConsultantRole,  //Pass the value of consultant row input to server
                                consultantPosition: newConsultantPosition
                            },
                            function (data) { //Call back function to excute after the request to the server is processed
                                addedConsultant = JSON.parse(data);
                                addConsultantToTable(addedConsultant, clients);
                            });
                    })
                }
                else {
                    alert("Name is not unique");
                }
            })
        })

        //Add a click event to all remove remove consultant button on the client table
        $("#consultantstable").on("click", ".remove-consultant-btn",
            function () {
                var thisConsultantRow = {},
                    consultantID = "";

                thisConsultantRow = $(this).closest("tr");
                consultantName = thisConsultantRow.data('name');
                consultantID = thisConsultantRow.prop("id");

                $.post("removeConsultant.php", //Request data from server using POST, url is removeClient.php
                    {
                        consultantID: consultantID //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                    }, function (data) {
                        thisConsultantRow.remove(); //Remove the closest table row to the button

                        //Loop though all the client WHO collumns and remove the consultant's name.
                        $('#clienttablebody > tr').each(function () {
                            var clientRow = $(this);
                            whoColumn = clientRow.find('.who-column');
                            allocatedClients = whoColumn.html();
                            allocatedClients = allocatedClients.replace(consultantName, "");
                            whoColumn.html(allocatedClients);
                        })
                    });

            });

        //WHen the dropdown for a consultant is chnaged send this update to the database
        $("#consultantstable").on("change", ".clientdropdown", function () {
            var selectedClientAbbrevation = "",
                allocationNo = "",
                consultantRow = {},
                consultantID = 0;

            selectedClientAbbrevation = $(this).find(":selected").val();
            allocationNo = $(this).prop("id");
            consultantRow = $(this).closest("tr");
            consultantID = consultantRow.prop("id")

            $.post("updateAllocation.php",
                {
                    consultantID: consultantID,
                    clientAbbrevation: selectedClientAbbrevation,
                    allocationNo: allocationNo
                }, function (data) {
                    checkIfConsultantIsAllocatedToClients(consultantID);
                });
        });


        /*
        function checkIfConsultantIsAllocatedToClients
        
        Takes a consultant ID name as a parameter. Checks all of the consultant's allocations, and 
        makes any necessary adjustments to client's WHO colunm.
        
        */
        function checkIfConsultantIsAllocatedToClients(id) {
            $('#clienttablebody > tr').each(function () {
                var clientRow = $(this);
                var i = 0;
                var consultantRow = $("#consultantstablebody").find("#" + id);
                var consultantName = consultantRow.data('name');

                allocatedClients = clientRow.find(".who-column").html();

                for (i; i < 10; i++) {
                    allocation = consultantRow.find("#allocation" + i);
                    if (allocation.val() == clientRow.data('abbrevation')) {
                        if (!(allocatedClients.includes(consultantName))) {
                            allocatedClients += " " + consultantName;
                            whoColumn = clientRow.find(".who-column");
                            whoColumn.html(allocatedClients);
                        }
                        return;
                    }
                }
                allocatedClients = allocatedClients.replace(consultantName, "");
                clientRow.find(".who-column").html(allocatedClients);
            })
        }

        /*
        Add a event listener to the client name input that when clicked away from, saves the clients new name to the 
        database.
        */
        $('#maindiv').on('blur', ".client-name-input", function () {
            var newClientName = "",
                clientID = 0

            newClientName = $(this).val();
            clientID = $(this).closest('tr').prop('id');
            $.post("updateClientName.php",
                {
                    clientID: clientID,
                    clientName: newClientName
                }, function (data) {
                });
        });

        /*
       Add a event listener to the client name input that when clicked away from, saves the clients new name to the 
       database.
       */
        $('#maindiv').on('blur', ".consultant-name-input", function () {
            var newConsultantName = "",
                consultantID = 0

            newConsultantName = $(this).val();
            consultantID = $(this).closest('tr').prop('id');
            $.post("updateConsultantName.php",
                {
                    consultantID: consultantID,
                    consultantName: newConsultantName
                }, function (data) {
                    alert("Updated");
                });
        });


        //Populate page
        initialiseTables();

        $("#testbutton").click(function () {
        })
    })
</script>

<body>
    <div id="maindiv">
        <div id="consultantsdiv">
            <table id="consultantstable" class="table">
                <thead id="consultantstablehead">
                    <tr>
                        <th>Consultant</th>
                        <th colspan="2">Monday </th>
                        <th colspan="2">Tue</th>
                        <th colspan="2">Wed</th>
                        <th colspan="2">Thu</th>
                        <th colspan="2">Fri</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                    </tr>
                </thead>
                <tbody id="consultantstablebody">

                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Consultant Name" value="Test" id="consultantnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Consultant Role" value="Test" id="consultantroleinput" />
                </td>
                <td>
                    <input type="button" class="btn" value="Add Consultant" id="addconsultantbutton" />
                </td>
            </tr>
        </div>
        <div id="clientsdiv">
            <table id="clientstable" class="table">
                <thead id="clienttablehead">
                    <th>Client</th>
                    <th>Abbrevation</th>
                    <th>Who</th>
                </thead>
                <tbody id="clienttablebody">
                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Client Name" value="Test" id="clientnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Client Abbrevation" value="Tes" id="clientabrevationinput" maxlength="3" />
                </td>
                <td>
                    <input type="button" class="btn" value="Add Client" id="addclientbutton" />
                </td>
            </tr>
        </div>
        <input type="button" id="testbutton" value="Test">
        </input>
    </div>
</body>

</html>