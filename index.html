<!DOCTYPE html>
<html>

<head>
    <title>Glance</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
</head>

<style type="text/css">
    /* Inputs with the class .names now as appear as normal text  */

    .names {
        background: rgba(0, 0, 0, 0);
        border: none;
    }
</style>

<script>
    $(document).ready(function () { //Load the javascript when the page is loaded

        var clients = [],
            consultants = [];

        //Retrieve the JSON representation of clients from the server 
        $.get("getClients.php", function (data, status) {
            clients = JSON.parse(data); //Decode json to array of clients

            //Retrieve the JSON representation of clients from the server
            $.get("getConsultants.php", function (data, status) {

                consultants = JSON.parse(data); //Decode json to array of consultants
                //Populate the client table with information from the database
                for (x in clients) {
                    addClientRow(clients[x]);
                }
                //Populate the consultant table with information from the database
                for (x in consultants) {
                    addConsultantRow(consultants[x]);
                }
            })
        })

        // Add a click event to the add client button
        $("#addclientbutton").click(function () { //Add a click event to the addclientbutton
            $.post("addNewClient.php", //Request data from server using POST, url is addClient.php
                {
                    clientName: $("#clientnameinput").val(), //Pass the value of client name input to server
                    clientAbbrev: $("#clientabrevationinput").val()  //Pass the value of client abbrevation input to server
                },
                function (data) { //After response is recieved from server
                    addClientRow(JSON.parse(data)); //Append the data recieved from the server to the client table
                });
        });

        // Add a click event to the add consultant button
        $("#addconsultantbutton").click(function () { //Add a click event to the addclientbutton
            $.post("addNewConsultant.php", //Request data from server using POST, url is addClient.php
                {
                    consultantName: $("#consultantnameinput").val(), //Pass the value of client name input to server
                    consultantJob: $("#consultantroleinput").val()  //Pass the value of client abbrevation input to server
                },
                function (data) { //Call back function to excute after the request to the server is processed
                    addConsultantRow(JSON.parse(data));
                });
        });

        //Takes a single client and appends it to the client table
        function addClientRow(client) {
            var clientRow = "";
            clientRow += "<tr>";
            clientRow += "<td id='clientName' class='names'>" + client['name'] + "</td>";
            clientRow += "<td id='clientAbbrevation'>" + client['abbrevation'] + "</td>";
            clientRow += "<td id='" + client['name'] + "allocations'>";
            for (z in consultants) { //Loop through number of consultants
                consultant = consultants[z]; //Store a consultant
                var clientAllocations = "";
                for (const k in consultant) { //Loop through all the propoerties of th
                    //Start new string for client 
                    if (consultant[k] == client["abbrevation"]) { //Check that property of the consultant is the same as the the current client abbrevation
                        if (!(clientAllocations.includes(consultant["name"]))) { //Check that clientAllocations DOES NOT include the name of the selected consultant
                            clientAllocations += consultant["name"] + " ";
                        }
                    }
                }
                clientRow += clientAllocations;
            }
            clientRow += "</td>";
            clientRow += "<td><input type='button' id='removeClient' value='REMOVE'/></td>";
            clientRow += "</tr>";
            $("#clienttablebody").append(clientRow);
        }

        //Takes a single consulant and appends it to the consultant table
        function addConsultantRow(consultant) {
            var consultantRow = ""; //Begin new consultant row
            consultantRow += "<tr>";
            consultantRow += "<td><input  id='consultantName' class='names' value='" + consultant['name'] + "'></input><br>" + consultant['role'] + "</td>"
            for (i = 0; i < 10; i++) {
                consultantRow += "<td><select class='form-control clientdropdown' id='allocation" + i + "'>";
                consultantRow += "<option value='null'></option>"
                for (z in clients) {
                    var client = clients[z];
                    consultantRow += "<option value='" + client['abbrevation'] + "'";
                    if (consultant["allocation" + i] == client["abbrevation"]) {

                        consultantRow += " selected='selected'"
                    }
                    consultantRow += ">" + client['abbrevation'] + "</option>"
                }
                consultantRow += "</select></td>";
            }
            consultantRow += "<td><input type='button' id='removeConsultant' value='REMOVE'/></td>";
            consultantRow += "</tr>";
            $("#consultantstablebody").append(consultantRow);
        }

        //WHen the dropdown for a consultant i chnaged send this update to the database
        $("#consultantstable").on("change", ".clientdropdown", function () {

            var selectedClient = $(this).find(":selected").val();

            var allocationNo = $(this).prop("id");

            var consultantRow = $(this).closest("tr");
            var consultantName = consultantRow.find("#consultantName").prop("value");

            $.post("updateAllocation.php",
                {
                    consultantName: consultantName,
                    clientAbbrevation: selectedClient,
                    allocationNo: allocationNo
                }, function () {
                    alert("Updated Database");
                });
        });

        //Add a click event to all remove client button on the client table
        $("#clientstable").on("click", "#removeClient", function () {
            var thisClientRow = $(this).closest("tr"); //Store the client table row
            var thisClientAbbrevation = thisClientRow.find("#clientAbbrevation").html(); //Store client abbrevation
            var thisClientName = thisClientRow.find("#clientName").html(); //Store client name

            $.post("removeClient.php", //Request data from server using POST, url is removeClient.php
                {
                    clientName: thisClientName //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                }, function () {
                    $("option[value='" + thisClientAbbrevation + "']").remove(); //Remove the abbrevation from the consultant dropdown
                });
            $(this).closest("tr").remove(); //Remove the closest table row to the button
        });

        //Add a click event to all remove client button on the client table
        $("#consultantstable").on("click", "#removeConsultant", function () {

            alert($(this).closest("tr").find("#consultantName").html());

            $.post("removeConsultant.php", //Request data from server using POST, url is removeClient.php

                {
                    consultantName: $(this).closest("tr").find("#consultantName").html() //Pass the value of the table column with the id clientName within the closest table row to the removeclientbutton(this)
                });
            $(this).closest("tr").remove(); //Remove the closest table row to the button
        });


    });
</script>

<body>
    <div id="maindiv">
        <div id="consultantsdiv">
            <table id="consultantstable" class="table">
                <thead id="consultantstablehead">
                    <tr>
                        <th>Client</th>
                        <th colspan="2">Monday </th>
                        <th colspan="2">Tue</th>
                        <th colspan="2">Wed</th>
                        <th colspan="2">Thu</th>
                        <th colspan="2">Fri</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                        <th>AM</th>
                        <th>PM</th>
                    </tr>
                </thead>
                <tbody id="consultantstablebody">

                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Consultant Name" value="Test" id="consultantnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Consultant Role" value="Test" id="consultantroleinput" />
                </td>
                <td>
                    <input type="button" value="Add Consultant" id="addconsultantbutton" />
                </td>
            </tr>
        </div>
        <div id="clientsdiv">
            <table id="clientstable" class="table">
                <thead id="clienttablehead">
                    <th>Client</th>
                    <th>Abbrevation</th>
                    <th>Who</th>
                </thead>
                <tbody id="clienttablebody">
                </tbody>

            </table>
            <tr>
                <td>
                    <input type="text" placeholder="Client Name" value="Test" id="clientnameinput" />
                </td>
                <td>
                    <input type="text" placeholder="Client Abbrevation" value="Test" id="clientabrevationinput" />
                </td>
                <td>
                    <input type="button" value="Add Client" id="addclientbutton" />
                </td>
            </tr>
        </div>
    </div>
</body>


</html>